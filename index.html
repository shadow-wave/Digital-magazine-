<!DOCTYPE html>
<html lang="hi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>प्रेरणा - Premium Hindi Magazine</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Premium Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anek+Malayalam:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Noto+Serif+Devanagari:wght@300;400;500;600;700;900&family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,900;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- HTML2PDF Library for High-Quality PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy': '#0f172a',      
                        'navy-light': '#1e293b',
                        'gold': '#c29a5b',      
                        'gold-light': '#dfc28f',
                        'paper': '#ffffff',     
                        'ink': '#334155',       
                    },
                    fontFamily: {
                        'hindi': ['"Noto Serif Devanagari"', 'serif'],
                        'eng': ['"Playfair Display"', 'serif'],
                        'mal': ['"Anek Malayalam"', 'sans-serif'],
                        'body': ['"Lora"', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root { --page-width: 210mm; --page-height: 297mm; }
        body { background-color: #e2e8f0; -webkit-tap-highlight-color: transparent; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- MAGAZINE CANVAS (SCREEN) --- */
        .page-wrapper {
            width: 100%; 
            max-width: 800px;
            background-color: #ffffff; 
            box-shadow: 0 10px 40px -10px rgba(15, 23, 42, 0.15);
            margin: 0 auto; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            border-radius: 4px;
            overflow: hidden;
        }

        /* Inner Content Area */
        .page-inner {
            margin: 20mm; 
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 250mm;
        }

        /* Adjust margin when Admin Toolbar is visible */
        .admin-active .page-inner {
            margin-top: 25mm !important;
        }

        /* Typography & Columns */
        .editorial-columns { column-count: 1; column-gap: 12mm; text-align: justify; hyphens: auto; }
        .editorial-columns p { 
            margin-bottom: 6mm; 
            line-height: 1.8; 
            font-size: 11pt; 
            color: #334155; 
            font-family: 'Lora', 'Noto Serif Devanagari', serif; 
        }
        
        /* Modern Drop Cap */
        .drop-cap p:first-of-type::first-letter {
            font-size: 3.8rem; float: left; line-height: 0.8; padding: 4px 12px 0 0;
            color: #0f172a; font-weight: 900; font-family: 'Playfair Display', serif;
        }

        /* Doha Layout */
        .doha-block {
            position: relative; padding: 2rem 0; margin: 2.5rem 0; text-align: center;
            border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
            break-inside: avoid;
        }
        .doha-block::before {
            content: '❝'; position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            background: #ffffff; padding: 0 10px; color: #c29a5b; font-size: 2rem; line-height: 1; font-family: 'Playfair Display', serif;
        }
        .doha-block p { 
            font-size: 14pt !important; font-weight: 600; color: #0f172a; 
            margin-bottom: 0.8rem !important; font-family: 'Noto Serif Devanagari', serif; line-height: 1.9;
        }

        /* Translation Layout */
        .trans-block { margin-bottom: 2rem; padding-left: 1.5rem; border-left: 2px solid #c29a5b; break-inside: avoid; }
        .trans-block .hi { font-size: 13pt; font-weight: 600; color: #0f172a; font-family: 'Noto Serif Devanagari', serif; margin-bottom: 8px; line-height: 1.5;}
        .trans-block .ml { font-size: 11pt; color: #64748b; font-family: 'Anek Malayalam', sans-serif; line-height: 1.6;}

        /* Image Formatting */
        .img-editorial { margin-bottom: 2rem; background: white; }
        .img-editorial img { border-radius: 2px; }
        .pos-left { float: left; margin-right: 25px; width: 45%; shape-outside: margin-box; }
        .pos-right { float: right; margin-left: 25px; width: 45%; shape-outside: margin-box; }
        .pos-top { width: 100%; margin-bottom: 2.5rem; } .pos-bottom { width: 100%; margin-top: 2.5rem; margin-bottom: 0;}

        /* Form UI */
        .glass-input { 
            width: 100%; padding: 0.85rem 1rem; border: 1px solid #cbd5e1; border-radius: 6px; 
            background-color: #ffffff; font-family: 'Noto Serif Devanagari', serif; 
            outline: none; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .glass-input:focus { border-color: #0f172a; box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.05); }

        /* Mobile Layout tweaks */
        @media (max-width: 768px) {
            .page-wrapper { width: 96%; aspect-ratio: auto; min-height: 600px; }
            .page-inner { margin: 25px; min-height: auto; }
            .admin-active .page-inner { margin-top: 80px !important; }
            .editorial-columns { column-count: 1; }
            .pos-left, .pos-right { float: none; width: 100%; margin: 0 0 2rem 0; }
        }

        @media (min-width: 769px) { .editorial-columns { column-count: 2; } }

        /* --- PERFECT PRINT STYLES --- */
        @media print {
            @page { size: A4; margin: 0; }
            html, body { height: auto !important; overflow: visible !important; display: block !important; background: #ffffff !important; margin: 0 !important; padding: 0 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            nav, aside, .no-print, #adminModal, #toast, #loader, #editModal, .admin-toolbar { display: none !important; }
            
            .flex-1, .flex-col, .lg\:flex-row { display: block !important; }
            #printArea { position: static !important; display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            #pagesContainer { display: block !important; width: 100% !important; gap: 0 !important; }
            
            .page-wrapper { 
                position: relative !important; width: 210mm !important; height: 297mm !important; 
                margin: 0 !important; box-shadow: none !important; border-radius: 0 !important; 
                background-color: #ffffff !important; page-break-after: always !important; 
                break-after: page !important; border: none !important; float: none !important;
            }
            .page-inner { margin: 25mm 20mm 25mm 20mm !important; min-height: auto !important;}
            .admin-active .page-inner { margin-top: 25mm !important; } /* Reset margin for print */

            .editorial-columns { column-count: 2 !important; column-gap: 12mm !important; }
            .pos-left { float: left !important; width: 45% !important; margin-right: 8mm !important; }
            .pos-right { float: right !important; width: 45% !important; margin-left: 8mm !important; }
        }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen text-navy">

    <!-- Premium Navbar - Minimalist -->
    <nav class="sticky top-0 bg-white shadow-sm z-50 border-b border-gray-200 no-print">
        <div class="max-w-7xl mx-auto px-4 py-3 md:py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-navy p-2 rounded text-white"><i class="ph ph-feather-bold text-xl"></i></div>
                <div class="flex flex-col leading-none">
                    <h1 class="text-xl md:text-2xl font-black font-hindi tracking-wide text-navy">प्रेरणा</h1>
                    <p class="text-[9px] md:text-[10px] text-gray-500 uppercase tracking-[0.2em] font-eng mt-1">Literary Magazine</p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-2 md:gap-3 items-center flex-wrap justify-end">
                
                <!-- Admin Status Indicator -->
                <div id="adminStatusBadge" class="hidden items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded-full text-xs font-bold mr-2">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    Admin Active
                </div>

                <button id="adminBtn" onclick="openAdminModal()" class="p-2 text-gray-400 hover:text-navy transition rounded-full hover:bg-gray-100" title="Admin Login">
                    <i class="ph ph-shield-check text-xl"></i>
                </button>
                
                <button id="logoutBtn" onclick="logoutAdmin()" class="hidden p-2 text-red-400 hover:text-red-600 transition rounded-full hover:bg-red-50" title="Logout Admin">
                    <i class="ph ph-sign-out text-xl"></i>
                </button>

                <button id="wordBtn" onclick="downloadAsWord()" class="hidden border border-gray-300 hover:bg-gray-50 text-navy px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition" title="Export to MS Word">
                    <i class="ph ph-file-doc text-lg"></i> <span class="hidden sm:inline">Word</span>
                </button>
                
                <button onclick="downloadPDF()" class="bg-indigo-50 border border-indigo-100 hover:bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition shadow-sm" title="High Quality PDF">
                    <i class="ph ph-download-simple text-lg"></i> <span class="hidden md:inline">Download PDF</span>
                </button>
                
                <button onclick="window.print()" class="bg-navy hover:bg-navy-light text-white px-4 py-1.5 rounded text-xs font-bold flex items-center gap-2 transition shadow-md">
                    <i class="ph ph-printer text-lg"></i> <span class="hidden md:inline">Print</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Layout -->
    <div class="flex-1 w-full max-w-[1400px] mx-auto flex flex-col lg:flex-row gap-8 p-4 lg:p-8">
        
        <!-- Left Sidebar: Submission Form -->
        <aside class="w-full lg:w-[380px] flex-shrink-0 no-print">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden sticky top-24">
                
                <button onclick="toggleMobileForm()" class="w-full p-5 bg-navy text-white flex justify-between items-center lg:cursor-default group">
                    <div class="flex items-center gap-3">
                        <i class="ph ph-pen-nib text-xl text-gold-light"></i>
                        <div class="text-left">
                            <h2 class="font-bold font-hindi text-lg tracking-wide">रचना भेजें</h2>
                            <p class="text-[10px] text-gray-300 uppercase tracking-wider font-eng lg:hidden">Submit Article</p>
                        </div>
                    </div>
                    <i id="formArrow" class="ph ph-caret-down lg:hidden transition-transform duration-300"></i>
                </button>
                
                <div id="formContainer" class="p-6 hidden lg:block space-y-5">
                    <form id="magazineForm" class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-1">श्रेणी (Category)</label>
                            <select id="category" class="glass-input cursor-pointer appearance-none font-bold text-navy">
                                <option value="दोहा (Doha)">दोहा (Doha)</option>
                                <option value="अनुवाद (Translation)">अनुवाद (Translation)</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-1">शीर्षक (Title) <span class="text-red-500">*</span></label>
                                <input type="text" id="title" class="glass-input font-bold text-lg" placeholder="शीर्षक दर्ज करें...">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-1">नाम (Author) <span class="text-red-500">*</span></label>
                                <input type="text" id="author" class="glass-input" placeholder="आपका नाम...">
                            </div>
                        </div>

                        <div class="p-4 border border-gray-200 rounded bg-gray-50/50">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-2">चित्र (Image)</label>
                            <label class="flex flex-col items-center justify-center w-full h-20 border border-gray-300 border-dashed bg-white rounded cursor-pointer hover:border-navy transition group">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-image text-xl text-gray-400 group-hover:text-navy transition"></i>
                                    <span class="text-xs text-gray-500 font-hindi" id="fileName">फोटो चुनें</span>
                                </div>
                                <input type="file" id="image" accept="image/*" class="hidden">
                            </label>
                            
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mt-3 mb-1">स्थान (Position)</label>
                            <select id="imgPos" class="glass-input py-2 text-sm cursor-pointer appearance-none">
                                <option value="top">Top (ऊपर)</option>
                                <option value="bottom">Bottom (नीचे)</option>
                                <option value="left">Left Wrap (बाएं)</option>
                                <option value="right">Right Wrap (दाएं)</option>
                            </select>
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block">विषय (Content) <span class="text-red-500">*</span></label>
                                <span class="text-[9px] text-gray-400 font-eng italic">Translation: Hi ↵ Mal</span>
                            </div>
                            <textarea id="content" rows="6" placeholder="यहाँ लिखें..." class="glass-input resize-none leading-relaxed"></textarea>
                        </div>

                        <button type="button" id="submitBtn" class="w-full bg-navy text-white py-3.5 rounded shadow hover:bg-navy-light transition-colors font-bold font-hindi flex items-center justify-center gap-2 text-lg">
                            <i class="ph ph-paper-plane-right"></i> जमा करें
                        </button>
                    </form>
                </div>
            </div>
        </aside>

        <!-- Right: Print / Magazine Canvas -->
        <main class="flex-1 w-full flex flex-col items-center" id="printArea">
            <div id="pagesContainer" class="w-full flex flex-col items-center gap-10 pb-12">
                
                <!-- Minimalist Cover Page -->
                <div class="page-wrapper cover-page bg-white justify-center items-center relative overflow-hidden border-8 border-navy m-2">
                    <div class="absolute inset-4 border border-gray-200 z-10 pointer-events-none"></div>
                    <div class="z-20 text-center flex flex-col items-center w-full h-full justify-center px-12 py-20 bg-white">
                        
                        <div class="mb-10">
                            <h2 class="text-navy tracking-[0.4em] uppercase text-xs font-bold font-eng">Department of Hindi</h2>
                            <div class="h-px w-24 bg-gold mx-auto mt-4"></div>
                        </div>
                        
                        <h1 class="text-7xl md:text-[7.5rem] font-black mb-0 font-hindi text-navy tracking-tight" style="line-height: 1;">प्रेरणा</h1>
                        <p class="text-xl md:text-2xl font-eng text-gray-500 mt-4 italic tracking-widest">Prerana</p>
                        
                        <div class="my-12">
                            <i class="ph ph-feather text-4xl text-gold"></i>
                        </div>
                        
                        <h3 class="text-lg md:text-xl text-gray-600 font-hindi font-light tracking-wide">रचनात्मकता का नया सवेरा</h3>
                        
                        <div class="mt-auto pt-20 flex justify-between w-full text-xs tracking-[0.2em] uppercase font-bold text-navy font-eng border-t border-gray-200">
                            <span>Volume I</span>
                            <span>2025 - 2026</span>
                        </div>
                    </div>
                </div>

                <!-- Articles injected here -->
            </div>
        </main>
    </div>

    <!-- Edit Modal (Minimal) -->
    <div id="editModal" class="hidden fixed inset-0 bg-navy/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-2xl flex flex-col max-h-[90vh] overflow-hidden fade-in">
            <div class="px-6 py-4 bg-white border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-navy font-hindi flex items-center gap-2"><i class="ph ph-pencil-simple text-gold"></i> संपादित करें</h3>
                <button onclick="closeEditModal()" class="w-8 h-8 rounded bg-gray-50 text-gray-500 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition"><i class="ph ph-x"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-4">
                <input type="hidden" id="editArticleId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">श्रेणी</label>
                        <select id="editCategory" class="glass-input py-2 text-sm mt-1">
                            <option value="दोहा (Doha)">दोहा (Doha)</option>
                            <option value="अनुवाद (Translation)">अनुवाद (Translation)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">लेखक</label>
                        <input type="text" id="editAuthor" class="glass-input py-2 text-sm mt-1">
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">शीर्षक</label>
                    <input type="text" id="editTitle" class="glass-input font-bold mt-1 text-navy">
                </div>
                
                <div class="p-4 bg-gray-50 rounded border border-gray-200">
                    <label class="text-[10px] font-bold text-gray-400 uppercase block mb-2">चित्र बदलें</label>
                    <div class="flex items-center gap-4 mb-3">
                        <img id="editImagePreview" class="w-16 h-16 object-cover rounded border border-gray-300 hidden">
                        <label class="flex-1 cursor-pointer">
                            <div class="bg-white border border-gray-300 text-gray-600 px-4 py-2 rounded text-sm font-bold text-center hover:border-navy transition">Select Image</div>
                            <input type="file" id="editImage" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <select id="editImgPos" class="glass-input py-2 text-sm bg-white mb-2"><option value="top">Top</option><option value="bottom">Bottom</option><option value="left">Left Wrap</option><option value="right">Right Wrap</option></select>
                    <button id="removeImageBtn" class="text-xs text-red-500 font-bold w-full text-right hidden" onclick="removeEditImage()">Remove Image</button>
                    <input type="hidden" id="editImageStatus" value="keep">
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">विषय</label>
                    <textarea id="editContent" rows="6" class="glass-input mt-1 resize-none"></textarea>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-5 py-2 text-gray-500 font-bold hover:bg-gray-200 rounded transition">Cancel</button>
                <button onclick="saveEditArticle()" class="bg-navy hover:bg-navy-light text-white px-6 py-2 rounded font-bold shadow transition">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminModal" class="hidden fixed inset-0 bg-navy/80 z-[120] flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white p-8 rounded-lg w-full max-w-sm shadow-2xl fade-in text-center border-t-4 border-navy">
            <i class="ph ph-shield-check text-4xl text-navy mb-3"></i>
            <h3 class="font-bold text-xl text-navy mb-1 font-eng">Admin Access</h3>
            <p class="text-xs text-gray-400 mb-6">Enter password to manage content</p>
            
            <input type="password" id="adminPassword" placeholder="••••••••" class="w-full border border-gray-300 rounded p-3 mb-6 text-center text-xl tracking-widest focus:border-navy outline-none">
            
            <div class="flex gap-2">
                <button onclick="closeAdminModal()" class="flex-1 bg-gray-100 text-gray-600 py-2.5 rounded font-bold hover:bg-gray-200">Cancel</button>
                <button onclick="loginAdmin()" class="flex-1 bg-navy text-white py-2.5 rounded font-bold hover:bg-navy-light shadow">Login</button>
            </div>
        </div>
    </div>

    <!-- Loader & Toast -->
    <div id="loader" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[150] hidden flex flex-col items-center justify-center">
        <div class="text-navy text-center">
            <i class="ph ph-circle-notch text-4xl animate-spin mb-3"></i>
            <p class="font-bold tracking-widest font-eng text-xs uppercase" id="loaderText">Loading</p>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-navy text-white px-6 py-3 rounded shadow-xl opacity-0 transition-all duration-300 z-[200] font-bold text-sm pointer-events-none flex items-center gap-3 transform translate-y-4 font-hindi border-l-4 border-gold">
        <i class="ph ph-info text-gold text-lg" id="toastIcon"></i>
        <span id="toastMsg"></span>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyC-xd1hY9pLjN5KXdvhesDMRrjwRwj-fMk",
          authDomain: "schoolmagazine-3a227.firebaseapp.com",
          projectId: "schoolmagazine-3a227",
          storageBucket: "schoolmagazine-3a227.firebasestorage.app",
          messagingSenderId: "809998632823",
          appId: "1:809998632823:web:703ebce93680af8de78372",
          measurementId: "G-631XSZFLPQ"
        };
        const myAppId = 'school-magazine-v2-hindi';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, articlesList = [], isAdmin = false;

        // UI Core
        window.toggleMobileForm = () => {
            const fc = document.getElementById('formContainer');
            const fa = document.getElementById('formArrow');
            fc.classList.toggle('hidden');
            fc.classList.toggle('fade-in');
            fa.classList.toggle('rotate-180');
        };

        window.toggleLoader = (show, txt="Loading") => { 
            document.getElementById('loaderText').innerText = txt;
            document.getElementById('loader').classList.toggle('hidden', !show); 
        };

        window.showToast = (msg, type='info') => {
            const t = document.getElementById('toast'); 
            const ti = document.getElementById('toastIcon');
            document.getElementById('toastMsg').innerText = msg; 
            
            if(type === 'error') { ti.className = "ph ph-warning-circle text-red-400 text-lg"; t.style.borderColor = "#ef4444"; }
            else if(type === 'success') { ti.className = "ph ph-check-circle text-green-400 text-lg"; t.style.borderColor = "#22c55e"; }
            else { ti.className = "ph ph-info text-gold text-lg"; t.style.borderColor = "#c29a5b"; }

            t.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000);
        };

        document.getElementById('image').addEventListener('change', function(e) {
            const display = document.getElementById('fileName');
            display.textContent = e.target.files[0] ? e.target.files[0].name : "फोटो चुनें";
            display.classList.toggle('text-navy', !!e.target.files[0]);
        });

        // Firebase Sync
        onAuthStateChanged(auth, (u) => { if(u) { currentUser = u; fetchArticles(); } else signInAnonymously(auth); });

        function fetchArticles() {
            toggleLoader(true, "Fetching Articles...");
            onSnapshot(collection(db, 'artifacts', myAppId, 'public', 'data', 'articles'), (snap) => {
                articlesList = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => a.order - b.order);
                renderMagazine();
                toggleLoader(false);
            });
        }

        // Generate Premium HTML
        function renderMagazine() {
            const container = document.getElementById('pagesContainer');
            while(container.children.length > 1) container.removeChild(container.lastChild);

            if(articlesList.length === 0) {
                const empty = document.createElement('div');
                empty.className = "page-wrapper fade-in items-center justify-center text-gray-400 border border-gray-100 p-10 min-h-[300px]";
                empty.innerHTML = `<i class="ph ph-feather text-4xl mb-3 opacity-30"></i><p class="font-hindi text-sm">अभी तक कोई रचना नहीं है।</p>`;
                container.appendChild(empty);
                return;
            }

            articlesList.forEach((article, index) => {
                const imgPos = article.imgPos || 'top';
                let imgHtml = '';
                if(article.image) {
                    imgHtml = `<div class="img-editorial ${'pos-'+imgPos}"><img src="${article.image}" class="w-full h-auto object-cover" style="max-height: 320px;"></div>`;
                }

                let contentHtml = '';
                if (article.category === "दोहा (Doha)") {
                    contentHtml = `<div class="doha-block">
                        ${article.content.split('\n').map(l=>`<p>${l}</p>`).join('')}
                        </div>`;
                } else if (article.category === "अनुवाद (Translation)") {
                    const lines = article.content.split('\n').filter(l=>l.trim());
                    for(let i=0; i<lines.length; i+=2) {
                        contentHtml += `<div class="trans-block"><div class="hi">${lines[i]}</div><div class="ml">${lines[i+1]||''}</div></div>`;
                    }
                }
                
                if (article.category === "दोहा (Doha)" || article.category === "अनुवाद (Translation)") {
                    contentHtml = `<div class="editorial-columns" style="column-count:1;">${imgPos === 'bottom' ? contentHtml + imgHtml : imgHtml + contentHtml}</div>`;
                } else {
                    const lines = article.content.split('\n').filter(l=>l.trim()).map(l=>`<p>${l}</p>`).join('');
                    contentHtml = `<div class="editorial-columns drop-cap">${imgHtml}${lines}</div>`;
                }

                // Dedicated Full-Width Admin Toolbar per page
                let adminBar = '';
                let adminClass = '';
                if(isAdmin) {
                    adminClass = 'admin-active';
                    adminBar = `
                    <div class="admin-toolbar absolute top-0 left-0 w-full bg-navy/95 backdrop-blur text-white px-4 py-2.5 flex flex-wrap justify-between items-center no-print z-[60] border-b-2 border-gold shadow-md">
                        <div class="flex items-center gap-2">
                            <i class="ph ph-wrench text-gold text-lg"></i>
                            <span class="text-xs font-bold uppercase tracking-widest text-white">Admin Controls (Pg ${index + 1})</span>
                        </div>
                        <div class="flex items-center gap-1.5 mt-2 md:mt-0">
                            <button onclick="moveArticle('${article.id}', -1)" title="Move Up" class="px-2.5 py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs flex items-center gap-1 transition font-semibold"><i class="ph ph-arrow-up text-gold"></i> <span class="hidden sm:inline">Up</span></button>
                            <button onclick="moveArticle('${article.id}', 1)" title="Move Down" class="px-2.5 py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs flex items-center gap-1 transition font-semibold"><i class="ph ph-arrow-down text-gold"></i> <span class="hidden sm:inline">Down</span></button>
                            <div class="w-px h-5 bg-white/20 mx-2"></div>
                            <button onclick="openEditModal('${article.id}')" title="Edit Page" class="px-3 py-1.5 bg-blue-500/20 hover:bg-blue-500/40 text-blue-200 rounded text-xs flex items-center gap-1 transition font-bold border border-blue-500/30"><i class="ph ph-pencil-simple"></i> Edit</button>
                            <button onclick="deleteArticle('${article.id}')" title="Delete Page" class="px-3 py-1.5 bg-red-500/20 hover:bg-red-500/40 text-red-300 rounded text-xs flex items-center gap-1 transition font-bold border border-red-500/30"><i class="ph ph-trash"></i> Delete</button>
                        </div>
                    </div>`;
                }

                const page = document.createElement('div');
                page.className = `page-wrapper fade-in ${adminClass}`;
                page.innerHTML = `
                    ${adminBar}
                    <div class="page-inner">
                        
                        <!-- Header -->
                        <div class="flex justify-between items-center border-b border-gray-300 pb-3 mb-10 uppercase tracking-[0.2em] text-[10px] font-bold">
                            <span class="text-gold font-hindi">${article.category}</span>
                            <span class="text-gray-400 font-eng">Page ${String(index+1).padStart(2,'0')}</span>
                        </div>
                        
                        <!-- Title Area -->
                        <div class="text-center mb-12 px-4">
                            <h2 class="text-4xl md:text-5xl font-black text-navy font-hindi leading-tight mb-4">${article.title}</h2>
                            <div class="flex items-center justify-center gap-4">
                                <span class="text-xs font-hindi font-bold text-gray-500 tracking-wider">रचना • ${article.author}</span>
                            </div>
                        </div>

                        <!-- Content Flow -->
                        <div class="flex-1 overflow-hidden relative">
                            ${contentHtml}
                        </div>

                        <!-- Footer -->
                        <div class="mt-auto pt-6 flex justify-between items-center border-t border-gray-200">
                            <span class="text-[9px] uppercase tracking-[0.3em] font-eng font-bold text-gray-400">Prerana Edition</span>
                            <span class="text-[10px] text-gray-400 font-hindi">2025-26</span>
                        </div>
                    </div>
                `;
                container.appendChild(page);
            });
        }

        // Submit
        document.getElementById('submitBtn').addEventListener('click', async () => {
            const category = document.getElementById('category').value;
            const title = document.getElementById('title').value.trim();
            const author = document.getElementById('author').value.trim();
            const content = document.getElementById('content').value.trim();
            const imgFile = document.getElementById('image').files[0];
            const imgPos = document.getElementById('imgPos').value;

            if(!title || !author || !content) return showToast("कृपया सभी बॉक्स भरें", "error");

            toggleLoader(true, "Saving...");
            let imgData = null;
            if(imgFile) imgData = await compressImage(imgFile);

            try {
                await addDoc(collection(db, 'artifacts', myAppId, 'public', 'data', 'articles'), {
                    category, title, author, content, image: imgData, imgPos, order: Date.now()
                });
                document.getElementById('magazineForm').reset();
                document.getElementById('fileName').textContent = "फोटो चुनें";
                showToast("सफलतापूर्वक जमा किया गया!", "success");
                if(window.innerWidth < 1024) toggleMobileForm();
                setTimeout(()=> window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'}), 800);
            } catch(e) { showToast("Error saving", "error"); }
            toggleLoader(false);
        });

        // Admin Access
        window.openAdminModal = () => { document.getElementById('adminModal').classList.remove('hidden'); document.getElementById('adminPassword').focus(); };
        window.closeAdminModal = () => { document.getElementById('adminModal').classList.add('hidden'); document.getElementById('adminPassword').value = ''; };
        
        window.loginAdmin = () => {
            if(document.getElementById('adminPassword').value === "admin123") {
                isAdmin = true;
                closeAdminModal();
                
                // Update UI for Logged In state
                document.getElementById('adminBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('adminStatusBadge').classList.remove('hidden');
                document.getElementById('adminStatusBadge').classList.add('flex');
                document.getElementById('wordBtn').classList.remove('hidden');
                
                renderMagazine();
                showToast("Admin Mode Activated", "success");
            } else showToast("Wrong Password", "error");
        };

        window.logoutAdmin = () => {
            isAdmin = false;
            document.getElementById('adminBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('adminStatusBadge').classList.add('hidden');
            document.getElementById('adminStatusBadge').classList.remove('flex');
            document.getElementById('wordBtn').classList.add('hidden');
            renderMagazine();
            showToast("Logged out successfully");
        };

        // Actions
        window.deleteArticle = async (id) => {
            if(!isAdmin) return showToast("Admin access required!", "error");
            
            if(confirm("क्या आप वाकई इस पेज को डिलीट करना चाहते हैं? (Are you sure you want to permanently delete this page?)")) { 
                toggleLoader(true, "Deleting page..."); 
                try {
                    const docRef = doc(db, 'artifacts', myAppId, 'public', 'data', 'articles', id);
                    await deleteDoc(docRef); 
                    showToast("Page deleted successfully", "success");
                } catch(error) {
                    console.error("Delete Error:", error);
                    showToast("Failed to delete. Check Firebase Rules.", "error");
                } finally {
                    toggleLoader(false); 
                }
            }
        };

        window.moveArticle = async (id, dir) => {
            if(!isAdmin) return;
            const idx = articlesList.findIndex(a=>a.id===id);
            if(idx+dir >= 0 && idx+dir < articlesList.length) {
                toggleLoader(true, "Rearranging...");
                try {
                    const doc1 = articlesList[idx], doc2 = articlesList[idx+dir];
                    
                    let newOrder1 = doc2.order;
                    let newOrder2 = doc1.order;
                    if(newOrder1 === newOrder2) newOrder1 += (dir * 10); 

                    await updateDoc(doc(db, 'artifacts', myAppId, 'public', 'data', 'articles', doc1.id), {order: newOrder1});
                    await updateDoc(doc(db, 'artifacts', myAppId, 'public', 'data', 'articles', doc2.id), {order: newOrder2});
                } catch(e) {
                    showToast("Error moving page", "error");
                }
                toggleLoader(false);
            }
        };

        // Edit
        let editImgOriginal = null;
        window.openEditModal = (id) => {
            if(!isAdmin) return;
            const a = articlesList.find(x=>x.id===id);
            document.getElementById('editArticleId').value = a.id;
            document.getElementById('editCategory').value = a.category;
            document.getElementById('editTitle').value = a.title;
            document.getElementById('editAuthor').value = a.author;
            document.getElementById('editContent').value = a.content;
            document.getElementById('editImgPos').value = a.imgPos || 'top';
            editImgOriginal = a.image;
            
            const preview = document.getElementById('editImagePreview');
            const rmBtn = document.getElementById('removeImageBtn');
            if(a.image) { preview.src = a.image; preview.classList.remove('hidden'); rmBtn.classList.remove('hidden'); } 
            else { preview.classList.add('hidden'); rmBtn.classList.add('hidden'); }
            
            document.getElementById('editImageStatus').value = 'keep';
            document.getElementById('editModal').classList.remove('hidden');
        };
        window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');
        window.removeEditImage = () => { document.getElementById('editImageStatus').value = 'remove'; document.getElementById('editImagePreview').classList.add('hidden'); document.getElementById('removeImageBtn').classList.add('hidden'); };
        
        document.getElementById('editImage').addEventListener('change', (e) => {
             if(e.target.files[0]) {
                 document.getElementById('editImageStatus').value = 'change';
                 const r = new FileReader(); r.onload = (ev) => { document.getElementById('editImagePreview').src = ev.target.result; document.getElementById('editImagePreview').classList.remove('hidden'); document.getElementById('removeImageBtn').classList.remove('hidden'); };
                 r.readAsDataURL(e.target.files[0]);
             }
        });

        window.saveEditArticle = async () => {
            if(!isAdmin) return;
            toggleLoader(true, "Updating Page...");
            const id = document.getElementById('editArticleId').value;
            const status = document.getElementById('editImageStatus').value;
            let img = editImgOriginal;
            if(status === 'remove') img = null;
            if(status === 'change') img = await compressImage(document.getElementById('editImage').files[0]);

            try {
                await updateDoc(doc(db, 'artifacts', myAppId, 'public', 'data', 'articles', id), {
                    category: document.getElementById('editCategory').value, title: document.getElementById('editTitle').value,
                    author: document.getElementById('editAuthor').value, content: document.getElementById('editContent').value,
                    imgPos: document.getElementById('editImgPos').value, image: img
                });
                closeEditModal(); 
                showToast("Changes Saved!", "success");
            } catch(e) {
                showToast("Error updating page", "error");
            }
            toggleLoader(false); 
        };

        // --- EXPORT PDF USING HTML2PDF (HIGH QUALITY) ---
        window.downloadPDF = () => {
            toggleLoader(true, "Generating PDF...");
            const element = document.getElementById('pagesContainer');
            
            // Hide Admin tools before generating PDF
            const adminBars = document.querySelectorAll('.admin-toolbar');
            adminBars.forEach(bar => bar.style.display = 'none');
            
            // Remove margin-top offset for printing
            const wrappers = document.querySelectorAll('.page-wrapper');
            wrappers.forEach(w => w.classList.remove('admin-active'));

            const opt = {
                margin:       0,
                filename:     'Prerana_Magazine_2025.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, logging: false },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // Restore Admin tools
                adminBars.forEach(bar => bar.style.display = 'flex');
                if(isAdmin) wrappers.forEach(w => w.classList.add('admin-active'));
                toggleLoader(false);
                showToast("PDF Downloaded successfully!", "success");
            }).catch(err => {
                adminBars.forEach(bar => bar.style.display = 'flex');
                if(isAdmin) wrappers.forEach(w => w.classList.add('admin-active'));
                toggleLoader(false);
                showToast("Error creating PDF", "error");
            });
        };

        // --- EXPORT WORD (TEXT ONLY/BASIC IMAGES) ---
        window.downloadAsWord = () => {
            let html = `<html xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><style>body{font-family:'Lora', 'Mangal', serif;} .title{color:#0f172a;font-size:28pt;font-weight:bold;text-align:center; margin-bottom:5px;} .author{text-align:center;font-style:italic; color:#64748b; margin-bottom:30px; font-size:12pt} .cat{color:#c29a5b;font-weight:bold; border-bottom:1px solid #e2e8f0; padding-bottom:5px; text-transform:uppercase; font-size:10pt}</style></head><body>`;
            
            html += `<div style="text-align:center; page-break-after:always; padding-top:150px;">
                        <h2 style="color:#c29a5b; letter-spacing:3px; text-transform:uppercase">Department of Hindi</h2>
                        <h1 style="color:#0f172a; font-size:60pt; margin:10px 0;">प्रेरणा</h1>
                        <h3 style="color:#64748b;">Vol. I | 2025-26</h3>
                     </div>`;

            articlesList.forEach(a => {
                html += `<div style="page-break-after:always"><p class="cat">${a.category}</p><p class="title">${a.title}</p><p class="author">रचना: ${a.author}</p>`;
                if(a.image) html += `<div style="text-align:center; margin-bottom:20px"><img src="${a.image}" width="450"></div>`;
                
                if (a.category === "अनुवाद (Translation)") {
                    const lines = a.content.split('\n').filter(l=>l.trim());
                    for(let i=0; i<lines.length; i+=2) {
                        html += `<p style="font-weight:bold; color:#0f172a; font-size:14pt">${lines[i]}</p>`;
                        if(lines[i+1]) html += `<p style="color:#475569">${lines[i+1]}</p>`;
                        html += `<br>`;
                    }
                } else if (a.category === "दोहा (Doha)") {
                     html += `<div style="text-align:center; padding:20px 0;">` + a.content.split('\n').map(l=>`<p style="font-weight:bold;color:#0f172a; font-size:16pt">${l}</p>`).join('') + `</div>`;
                } else {
                     html += `<div style="text-align:justify; line-height:1.6; font-size:11pt">` + a.content.split('\n').map(l=>`<p>${l}</p>`).join('') + `</div>`;
                }
                
                html += `</div>`;
            });
            html += `</body></html>`;
            const b = new Blob(['\ufeff', html], {type:'application/msword'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download="Prerana_Magazine_Word_Export.doc"; a.click();
        };

        // Image Helper
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); let w = img.width, h = img.height;
                        if(w>h && w>1000) { h*=1000/w; w=1000; } else if(h>1000) { w*=1000/h; h=1000; }
                        cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.8)); // Higher quality for white theme
                    }
                }
            });
        }
    </script>
</body>
</html>


